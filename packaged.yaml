AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Description: A Node.js web service deployed to AWS Lambda.
Parameters:
  Stage:
    Type: String
    Description: The name for a project pipeline stage, such as Staging or Prod, for
      which resources are provisioned and deployed.
    Default: production
  RestApiName:
    Type: String
    Default: clickCollectionRestApi
  ClickCollectRestApiStageName:
    Type: String
    Default: production
Resources:
  ClickCollectRestApi:
    Type: AWS::ApiGateway::RestApi
    Properties:
      Name: Click&Collect REST API
      Description: handle all non-websocket routes
  SignUp:
    Type: AWS::ApiGateway::Resource
    Properties:
      RestApiId:
        Ref: ClickCollectRestApi
      PathPart: signup
      ParentId:
        Fn::GetAtt:
        - ClickCollectRestApi
        - RootResourceId
  ClickCollectRestApiSignUpMethod:
    Type: AWS::ApiGateway::Method
    Properties:
      AuthorizationType: NONE
      HttpMethod: POST
      Integration:
        IntegrationHttpMethod: POST
        Type: AWS
        Uri:
          Fn::Sub:
          - arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${lambdaArn}/invocations
          - lambdaArn:
              Fn::GetAtt:
              - LambdaSignUp
              - Arn
      ResourceId:
        Ref: SignUp
      RestApiId:
        Ref: ClickCollectRestApi
  SignIn:
    Type: AWS::ApiGateway::Resource
    Properties:
      RestApiId:
        Ref: ClickCollectRestApi
      PathPart: signin
      ParentId:
        Fn::GetAtt:
        - ClickCollectRestApi
        - RootResourceId
  ClickCollectRestApiSignInMethod:
    Type: AWS::ApiGateway::Method
    Properties:
      AuthorizationType: NONE
      HttpMethod: POST
      Integration:
        IntegrationHttpMethod: POST
        Type: AWS
        Uri:
          Fn::Sub:
          - arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${lambdaArn}/invocations
          - lambdaArn:
              Fn::GetAtt:
              - LambdaCognitoAuthenticator
              - Arn
      ResourceId:
        Ref: SignIn
      RestApiId:
        Ref: ClickCollectRestApi
  ClickCollectRestApiDeployment:
    Type: AWS::ApiGateway::Deployment
    DependsOn:
    - ClickCollectRestApiSignUpMethod
    - ClickCollectRestApiSignInMethod
    Properties:
      RestApiId:
        Ref: ClickCollectRestApi
      StageName:
        Ref: ClickCollectRestApiStageName
  signUpGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName:
        Fn::Sub: /aws/lambda/${LambdaSignUp}
      RetentionInDays: 90
  ApiGwAccountConfig:
    DependsOn:
    - ClickCollectWebsocket
    Type: AWS::ApiGateway::Account
    Properties:
      CloudWatchRoleArn:
        Fn::GetAtt:
        - ClickCollectWebsocketLoggingRole
        - Arn
  ClickCollectWebsocket:
    Type: AWS::ApiGatewayV2::Api
    Properties:
      Name: ClickCollectWebsocket
      ProtocolType: WEBSOCKET
      RouteSelectionExpression: $request.body.message
      CredentialsArn:
        Fn::GetAtt:
        - ClickCollectWebsocketRole
        - Arn
  ClickCollectWebsocketRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
        - Effect: Allow
          Principal:
            Service:
            - apigateway.amazonaws.com
          Action:
          - sts:AssumeRole
      Policies:
      - PolicyName: LambdaBasicExecutionPolicy
        PolicyDocument:
          Version: '2012-10-17'
          Statement:
            Effect: Allow
            Action:
            - logs:CreateLogGroup
            - logs:CreateLogStream
            - logs:PutLogEvents
            Resource: '*'
      Path: /
  ClickCollectWebsocketLoggingRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
        - Effect: Allow
          Principal:
            Service:
            - apigateway.amazonaws.com
          Action: sts:AssumeRole
      Path: /
      ManagedPolicyArns:
      - Fn::Sub: arn:${AWS::Partition}:iam::aws:policy/service-role/AmazonAPIGatewayPushToCloudWatchLogs
  ClickCollectConnectRoute:
    Type: AWS::ApiGatewayV2::Route
    Properties:
      ApiId:
        Ref: ClickCollectWebsocket
      RouteKey: $connect
      AuthorizationType: CUSTOM
      AuthorizerId:
        Ref: CognitoLambdaAuthorizer
      OperationName: ClickCollectConnectRoute
      Target:
        Fn::Join:
        - /
        - - integrations
          - Ref: ClickCollectConnectInteg
  ClickCollectConnectInteg:
    Type: AWS::ApiGatewayV2::Integration
    Properties:
      ApiId:
        Ref: ClickCollectWebsocket
      Description: Integration for builtin $connect route
      IntegrationType: AWS
      IntegrationUri:
        Fn::Sub:
        - arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${Function}/invocations
        - Function:
            Fn::GetAtt:
            - WebSocketRouteConnect
            - Arn
      TemplateSelectionExpression: '200'
      RequestTemplates:
        '200': "{\n    \"userEmail\": \"$context.authorizer.userEmail\",\n    \"connectionId\"\
          : \"$context.connectionId\",\n    \"connectionType\": \"$context.connectionType\"\
          \n}\n"
  ClickCollectDisconnectRoute:
    Type: AWS::ApiGatewayV2::Route
    Properties:
      ApiId:
        Ref: ClickCollectWebsocket
      RouteKey: $disconnect
      OperationName: ClickCollectDisconnectRoute
      RouteResponseSelectionExpression: $default
      Target:
        Fn::Join:
        - /
        - - integrations
          - Ref: ClickCollectDisconnectInteg
  ClickCollectDisconnectInteg:
    Type: AWS::ApiGatewayV2::Integration
    Properties:
      ApiId:
        Ref: ClickCollectWebsocket
      Description: Integration for builtin $disconnect route
      IntegrationType: AWS
      IntegrationUri:
        Fn::Sub:
        - arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${Function}/invocations
        - Function:
            Fn::GetAtt:
            - WebSocketRouteDisconnect
            - Arn
      TemplateSelectionExpression: '200'
      RequestTemplates:
        '200': "{\n    \"userEmail\": \"$context.authorizer.userEmail\",\n    \"connectionId\"\
          : \"$context.connectionId\",\n    \"connectionType\": \"$context.connectionType\"\
          \n}\n"
  ClickCollectDefaultRoute:
    Type: AWS::ApiGatewayV2::Route
    Properties:
      ApiId:
        Ref: ClickCollectWebsocket
      RouteKey: $default
      OperationName: ClickCollectDefaultRoute
      RouteResponseSelectionExpression: $default
      Target:
        Fn::Join:
        - /
        - - integrations
          - Ref: ClickCollectDefaultInteg
  ClickCollectDefaultInteg:
    Type: AWS::ApiGatewayV2::Integration
    Properties:
      ApiId:
        Ref: ClickCollectWebsocket
      Description: Integration for builtin $default route
      IntegrationType: MOCK
  ClickCollectUpdateLocationRoute:
    Type: AWS::ApiGatewayV2::Route
    Properties:
      ApiId:
        Ref: ClickCollectWebsocket
      RouteKey: updateLocation
      OperationName: ClickCollectUpdateLocationRoute
      Target:
        Fn::Join:
        - /
        - - integrations
          - Ref: ClickCollectUpdateLocationInteg
  ClickCollectUpdateLocationInteg:
    Type: AWS::ApiGatewayV2::Integration
    Properties:
      ApiId:
        Ref: ClickCollectWebsocket
      Description: Pairing request integration
      IntegrationType: AWS
      IntegrationUri:
        Fn::Sub:
        - arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${Function}/invocations
        - Function:
            Fn::GetAtt:
            - LambdaWebSocketRouteUpdateLocation
            - Arn
  ClickCollectAcceptRequestRoute:
    Type: AWS::ApiGatewayV2::Route
    Properties:
      ApiId:
        Ref: ClickCollectWebsocket
      RouteKey: acceptRequest
      OperationName: ClickCollectAcceptRequestRoute
      Target:
        Fn::Join:
        - /
        - - integrations
          - Ref: ClickCollectAcceptRequestInteg
  ClickCollectAcceptRequestInteg:
    Type: AWS::ApiGatewayV2::Integration
    Properties:
      ApiId:
        Ref: ClickCollectWebsocket
      Description: Integration for custom 'status' route
      IntegrationType: AWS
      IntegrationUri:
        Fn::Sub:
        - arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${Function}/invocations
        - Function:
            Fn::GetAtt:
            - WebSocketRouteAcceptRequest
            - Arn
      TemplateSelectionExpression: '200'
      RequestTemplates:
        '200': "#set($inputRoot = $input.path('$')) {\n  \"connectionId\" : \"$context.connectionId\"\
          \n  \"connectionType\" : \"$context.connectionType\",\n  \"requestId\" :\
          \ \"$inputRoot.data.requestId\",\n  \"token\": \"$inputRoot.token\"\n}\n"
  ClickCollectRejectRequestRoute:
    Type: AWS::ApiGatewayV2::Route
    Properties:
      ApiId:
        Ref: ClickCollectWebsocket
      RouteKey: rejectRequest
      OperationName: ClickCollectRejectRequestRoute
      Target:
        Fn::Join:
        - /
        - - integrations
          - Ref: ClickCollectRejectRequestInteg
  ClickCollectRejectRequestInteg:
    Type: AWS::ApiGatewayV2::Integration
    Properties:
      ApiId:
        Ref: ClickCollectWebsocket
      Description: Integration for custom 'status' route
      IntegrationType: AWS
      IntegrationUri:
        Fn::Sub:
        - arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${Function}/invocations
        - Function:
            Fn::GetAtt:
            - WebSocketRouteRejectRequest
            - Arn
      TemplateSelectionExpression: '200'
      RequestTemplates:
        '200': "#set($inputRoot = $input.path('$')) {\n  \"connectionId\" : \"$context.connectionId\"\
          \n  \"connectionType\" : \"$context.connectionType\",\n  \"requestId\" :\
          \ \"$inputRoot.data.requestId\",\n  \"token\": \"$inputRoot.token\"\n}\n"
  ClickCollectSubmitAnswersRoute:
    Type: AWS::ApiGatewayV2::Route
    Properties:
      ApiId:
        Ref: ClickCollectWebsocket
      RouteKey: submitAnswers
      OperationName: ClickCollectSubmitAnswersRoute
      Target:
        Fn::Join:
        - /
        - - integrations
          - Ref: ClickCollectSubmitAnswersInteg
  ClickCollectSubmitAnswersInteg:
    Type: AWS::ApiGatewayV2::Integration
    Properties:
      ApiId:
        Ref: ClickCollectWebsocket
      Description: Integration for custom 'status' route
      IntegrationType: AWS
      IntegrationUri:
        Fn::Sub:
        - arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${Function}/invocations
        - Function:
            Fn::GetAtt:
            - LambdaWebSocketRouteSubmitAnswers
            - Arn
  CognitoLambdaAuthorizer:
    Type: AWS::ApiGatewayV2::Authorizer
    Properties:
      Name: CustomCognitoAuthorizer
      ApiId:
        Ref: ClickCollectWebsocket
      AuthorizerType: REQUEST
      AuthorizerUri:
        Fn::Sub:
        - arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${Authorizer}/invocations
        - Authorizer:
            Fn::GetAtt:
            - LambdaCognitoAuthorizer
            - Arn
      IdentitySource:
      - route.request.querystring.Authorizer
  ClickCollectWebSocketDeployment:
    Type: AWS::ApiGatewayV2::Deployment
    DependsOn:
    - ClickCollectConnectRoute
    - ClickCollectDisconnectRoute
    - ClickCollectDefaultRoute
    - ClickCollectUpdateLocationRoute
    - ClickCollectAcceptRequestRoute
    Properties:
      ApiId:
        Ref: ClickCollectWebsocket
  ClickCollectWebSocketStage:
    Type: AWS::ApiGatewayV2::Stage
    Properties:
      StageName:
        Fn::Sub: ${Stage}
      Description:
        Fn::Sub: ${Stage} traffic
      DeploymentId:
        Ref: ClickCollectWebSocketDeployment
      ApiId:
        Ref: ClickCollectWebsocket
      DefaultRouteSettings:
        LoggingLevel: INFO
        DataTraceEnabled: true
      AccessLogSettings:
        DestinationArn:
          Fn::Sub: arn:aws:logs:${AWS::Region}:${AWS::AccountId}:log-group:clickcollect-wss-access-logs
        Format: '''{"requestId":"$context.requestId", "ip": "$context.identity.sourceIp",
          "caller":"$context.identity.caller", "user":"$context.identity.user","requestTime":"$context.requestTime",
          "eventType":"$context.eventType","routeKey":"$context.routeKey", "status":"$context.status","connectionId":"$context.connectionId"}'''
  MongoDBEventBridge:
    Type: AWS::Events::EventBus
    Properties:
      EventSourceName: aws.partner/mongodb.com/stitch.trigger/5ea164b7525542a0607d79b9
      Name: aws.partner/mongodb.com/stitch.trigger/5ea164b7525542a0607d79b9
  searchPlayersEventRule:
    Type: AWS::Events::Rule
    Properties:
      Description: search_for_players
      EventBusName:
        Ref: MongoDBEventBridge
      EventPattern:
        account:
        - Ref: AWS::AccountId
      State: ENABLED
      Targets:
      - Arn:
          Fn::GetAtt:
          - LambdaMatchPlayers
          - Arn
        Id: LambdaMatchPlayers
  ClickCollectCognitoUserPool:
    Type: AWS::Cognito::UserPool
    Properties:
      AccountRecoverySetting:
        RecoveryMechanisms:
        - Name: verified_email
          Priority: 1
      AutoVerifiedAttributes:
      - email
      AliasAttributes:
      - email
      LambdaConfig:
        PostConfirmation:
          Fn::GetAtt:
          - CognitoInitializePlayer
          - Arn
      Policies:
        PasswordPolicy:
          MinimumLength: 6
          RequireLowercase: true
          RequireNumbers: true
          RequireSymbols: false
          RequireUppercase: true
      UsernameConfiguration:
        CaseSensitive: true
      UserPoolName: click
  ClickCollectCognitoUserPoolClient:
    Type: AWS::Cognito::UserPoolClient
    Properties:
      ClientName: clickCollectCognitoUserPoolClient
      GenerateSecret: false
      PreventUserExistenceErrors: ENABLED
      RefreshTokenValidity: 1
      SupportedIdentityProviders:
      - COGNITO
      UserPoolId:
        Ref: ClickCollectCognitoUserPool
  DynamodbRequestsTable:
    Type: AWS::DynamoDB::Table
    Properties:
      AttributeDefinitions:
      - AttributeName: _id
        AttributeType: S
      KeySchema:
      - AttributeName: _id
        KeyType: HASH
      ProvisionedThroughput:
        ReadCapacityUnits: '5'
        WriteCapacityUnits: '5'
      TableName: requests
  DynamodbGamesTable:
    Type: AWS::DynamoDB::Table
    Properties:
      AttributeDefinitions:
      - AttributeName: _id
        AttributeType: S
      KeySchema:
      - AttributeName: _id
        KeyType: HASH
      ProvisionedThroughput:
        ReadCapacityUnits: '5'
        WriteCapacityUnits: '5'
      TableName: games
      StreamSpecification:
        StreamViewType: NEW_IMAGE
  DynamodbQuestionsTable:
    Type: AWS::DynamoDB::Table
    Properties:
      AttributeDefinitions:
      - AttributeName: _id
        AttributeType: S
      KeySchema:
      - AttributeName: _id
        KeyType: HASH
      ProvisionedThroughput:
        ReadCapacityUnits: '5'
        WriteCapacityUnits: '5'
      TableName: questions
  PendingRequestsQue:
    Type: AWS::SQS::Queue
    Properties:
      MessageRetentionPeriod: 86400
      QueueName: PendingRequests
      VisibilityTimeout: 300
  PendingGamesQue:
    Type: AWS::SQS::Queue
    Properties:
      MessageRetentionPeriod: 86400
      QueueName: PendingGames
      VisibilityTimeout: 300
  PendingResultsQue:
    Type: AWS::SQS::Queue
    Properties:
      MessageRetentionPeriod: 86400
      QueueName: PendingResults
      VisibilityTimeout: 300
  PendingTransferQue:
    Type: AWS::SQS::Queue
    Properties:
      MessageRetentionPeriod: 86400
      QueueName: PendingTransfer
      VisibilityTimeout: 300
  PendingQuestionsQue:
    Type: AWS::SQS::Queue
    Properties:
      MessageRetentionPeriod: 86400
      QueueName: PendingQuestions
      VisibilityTimeout: 300
  WebSocketRouteConnect:
    Type: AWS::Serverless::Function
    DependsOn:
    - LambdaBasicExecutionPolicy
    Properties:
      FunctionName: webSocketRouteConnect
      Handler: connect.handler
      Runtime: nodejs12.x
      CodeUri: s3://ali-su-artifacts/5946adca9c211e3abd2ccdbd3b62aeb7
      Layers:
      - Ref: serverlessLayer
      Timeout: 3
      MemorySize: 128
      Role:
        Fn::GetAtt:
        - WebSocketRouteConnectRole
        - Arn
      Environment:
        Variables:
          MONGO_DB_URI: mongodb+srv://admin:extra4545@cluster0-xebut.mongodb.net/test?retryWrites=true&w=majority
  ClickCollectConnectIntegPermission:
    Type: AWS::Lambda::Permission
    Properties:
      Action: lambda:InvokeFunction
      FunctionName:
        Ref: WebSocketRouteConnect
      Principal: apigateway.amazonaws.com
      SourceArn:
        Fn::Sub: arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${ClickCollectWebsocket}/*/$connect
  WebSocketRouteConnectRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
        - Effect: Allow
          Principal:
            Service:
            - lambda.amazonaws.com
          Action:
          - sts:AssumeRole
  WebSocketRouteDisconnect:
    Type: AWS::Serverless::Function
    DependsOn:
    - LambdaBasicExecutionPolicy
    Properties:
      FunctionName: webSocketRouteDisconnect
      Handler: disconnect.handler
      Runtime: nodejs12.x
      CodeUri: s3://ali-su-artifacts/2e43395a37d09a01d841e5f8971c912a
      Layers:
      - Ref: serverlessLayer
      Timeout: 3
      MemorySize: 128
      Role:
        Fn::GetAtt:
        - WebSocketRouteDisconnectRole
        - Arn
      Environment:
        Variables:
          MONGO_DB_URI: mongodb+srv://admin:extra4545@cluster0-xebut.mongodb.net/test?retryWrites=true&w=majority
  WebSocketRouteDisconnectPermission:
    Type: AWS::Lambda::Permission
    Properties:
      Action: lambda:InvokeFunction
      FunctionName:
        Ref: WebSocketRouteDisconnect
      Principal: apigateway.amazonaws.com
      SourceArn:
        Fn::Sub: arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${ClickCollectWebsocket}/*/$disconnect
  WebSocketRouteDisconnectRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
        - Effect: Allow
          Principal:
            Service:
            - lambda.amazonaws.com
          Action:
          - sts:AssumeRole
  CognitoInitializePlayer:
    Type: AWS::Serverless::Function
    DependsOn:
    - LambdaBasicExecutionPolicy
    Properties:
      FunctionName: cognitoInitializePlayer
      Handler: index.handler
      Runtime: nodejs12.x
      CodeUri: s3://ali-su-artifacts/89ec0d107e052763c003ee97663eff2b
      Layers:
      - Ref: serverlessLayer
      Timeout: 3
      MemorySize: 128
      Role:
        Fn::GetAtt:
        - CognitoInitializePlayerRole
        - Arn
      Environment:
        Variables:
          MONGO_DB_URI: mongodb+srv://admin:extra4545@cluster0-xebut.mongodb.net/test?retryWrites=true&w=majority
  CognitoInitializePlayerPermission:
    Type: AWS::Lambda::Permission
    Properties:
      Action: lambda:InvokeFunction
      FunctionName:
        Ref: CognitoInitializePlayer
      Principal: cognito-idp.amazonaws.com
      SourceArn:
        Fn::GetAtt:
        - ClickCollectCognitoUserPool
        - Arn
  CognitoInitializePlayerRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
        - Effect: Allow
          Principal:
            Service:
            - lambda.amazonaws.com
          Action:
          - sts:AssumeRole
  LambdaWebSocketRouteUpdateLocation:
    Type: AWS::Serverless::Function
    DependsOn:
    - LambdaBasicExecutionPolicy
    Properties:
      FunctionName: LambdaWebSocketRouteUpdateLocation
      Handler: index.handler
      Runtime: nodejs12.x
      CodeUri: s3://ali-su-artifacts/7fbf9ec52889e7e35641c89c15041677
      Layers:
      - Ref: serverlessLayer
      Timeout: 3
      MemorySize: 128
      Role:
        Fn::GetAtt:
        - LambdaWebSocketRouteUpdateLocationRole
        - Arn
      Environment:
        Variables:
          MONGO_DB_URI: mongodb+srv://admin:extra4545@cluster0-xebut.mongodb.net/test?retryWrites=true&w=majority
  LambdaWebSocketRouteUpdateLocationPermission:
    Type: AWS::Lambda::Permission
    Properties:
      Action: lambda:InvokeFunction
      FunctionName:
        Ref: LambdaWebSocketRouteUpdateLocation
      Principal: apigateway.amazonaws.com
      SourceArn:
        Fn::Sub: arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${ClickCollectWebsocket}/*/updateLocation
  LambdaWebSocketRouteUpdateLocationRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
        - Effect: Allow
          Principal:
            Service:
            - lambda.amazonaws.com
          Action:
          - sts:AssumeRole
      Path: /
  WebSocketRouteAcceptRequest:
    Type: AWS::Serverless::Function
    DependsOn:
    - LambdaBasicExecutionPolicy
    Properties:
      FunctionName: webSocketRouteAcceptRequest
      Handler: index.handler
      Runtime: nodejs12.x
      CodeUri: s3://ali-su-artifacts/c569130c93d23f8e49fd4ac0820d91ad
      Layers:
      - Ref: serverlessLayer
      Timeout: 3
      MemorySize: 128
      Role:
        Fn::GetAtt:
        - WebSocketRouteAcceptRequestRole
        - Arn
      Environment:
        Variables:
          DYNAMODB_REQUESTS_TABLE:
            Ref: DynamodbRequestsTable
  WebSocketRouteAcceptRequestPermission:
    Type: AWS::Lambda::Permission
    Properties:
      Action: lambda:InvokeFunction
      FunctionName:
        Ref: WebSocketRouteAcceptRequest
      Principal: apigateway.amazonaws.com
      SourceArn:
        Fn::Sub: arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${ClickCollectWebsocket}/*/acceptRequest
  WebSocketRouteAcceptRequestRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
        - Effect: Allow
          Principal:
            Service:
            - lambda.amazonaws.com
          Action:
          - sts:AssumeRole
      Policies:
      - PolicyName: DynamodbRequestsTableWriteAccess
        PolicyDocument:
          Version: '2012-10-17'
          Statement:
            Effect: Allow
            Action:
            - dynamodb:UpdateItem
            Resource:
              Fn::GetAtt:
              - DynamodbRequestsTable
              - Arn
      Path: /
  WebSocketRouteRejectRequest:
    Type: AWS::Serverless::Function
    DependsOn:
    - LambdaBasicExecutionPolicy
    Properties:
      FunctionName: webSocketRouteRejectRequest
      Handler: index.handler
      Runtime: nodejs12.x
      CodeUri: s3://ali-su-artifacts/f28d85050193ba105b2a038637375fcd
      Layers:
      - Ref: serverlessLayer
      Timeout: 3
      Role:
        Fn::GetAtt:
        - WebSocketRouteRejectRequestRole
        - Arn
      MemorySize: 128
      Environment:
        Variables:
          DYNAMODB_REQUESTS_TABLE:
            Ref: DynamodbRequestsTable
  ClickCollectRejectRequestIntegPermission:
    Type: AWS::Lambda::Permission
    Properties:
      Action: lambda:InvokeFunction
      FunctionName:
        Ref: WebSocketRouteRejectRequest
      Principal: apigateway.amazonaws.com
      SourceArn:
        Fn::Sub: arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${ClickCollectWebsocket}/*/rejectRequest
  WebSocketRouteRejectRequestRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
        - Effect: Allow
          Principal:
            Service:
            - lambda.amazonaws.com
          Action:
          - sts:AssumeRole
      Policies:
      - PolicyName: DynamodbRequestsTableWriteAccess
        PolicyDocument:
          Version: '2012-10-17'
          Statement:
            Effect: Allow
            Action:
            - dynamodb:UpdateItem
            Resource:
              Fn::GetAtt:
              - DynamodbRequestsTable
              - Arn
      Path: /
  LambdaWebSocketRouteSubmitAnswers:
    Type: AWS::Serverless::Function
    DependsOn:
    - LambdaBasicExecutionPolicy
    Properties:
      FunctionName: LambdaWebSocketRouteSubmitAnswers
      Handler: index.handler
      Runtime: nodejs12.x
      CodeUri: s3://ali-su-artifacts/36d369f94f7240de6cd240318dde0c42
      Layers:
      - Ref: serverlessLayer
      Timeout: 3
      MemorySize: 128
      Role:
        Fn::GetAtt:
        - LambdaWebSocketRouteSubmitAnswersRole
        - Arn
      Environment:
        Variables:
          MONGO_DB_URI: mongodb+srv://admin:extra4545@cluster0-xebut.mongodb.net/test?retryWrites=true&w=majority
          DYNAMODB_GAMES_TABLE:
            Ref: DynamodbGamesTable
  LambdaWebSocketRouteSubmitAnswersPermission:
    Type: AWS::Lambda::Permission
    Properties:
      Action: lambda:InvokeFunction
      FunctionName:
        Ref: LambdaWebSocketRouteSubmitAnswers
      Principal: apigateway.amazonaws.com
      SourceArn:
        Fn::Sub: arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${ClickCollectWebsocket}/*/submitAnswers
  LambdaWebSocketRouteSubmitAnswersRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
        - Effect: Allow
          Principal:
            Service:
            - lambda.amazonaws.com
          Action:
          - sts:AssumeRole
      Policies:
      - PolicyName: DynamodbGamesTableWriteAccess
        PolicyDocument:
          Version: '2012-10-17'
          Statement:
            Effect: Allow
            Action:
            - dynamodb:UpdateItem
            Resource:
              Fn::GetAtt:
              - DynamodbGamesTable
              - Arn
      Path: /
  LambdaCognitoAuthorizer:
    Type: AWS::Serverless::Function
    DependsOn:
    - LambdaBasicExecutionPolicy
    Properties:
      FunctionName: LambdaCognitoAuthorizer
      Handler: index.handler
      Runtime: nodejs12.x
      CodeUri: s3://ali-su-artifacts/a8a2116b27b61cfd5282ded79255c784
      Layers:
      - Ref: serverlessLayer
      Timeout: 3
      MemorySize: 128
      Role:
        Fn::GetAtt:
        - LambdaCognitoAuthorizerRole
        - Arn
      Environment:
        Variables:
          KEYS_URL:
            Fn::Sub: https://cognito-idp.us-east-1.amazonaws.com/${ClickCollectCognitoUserPool}/.well-known/jwks.json
  LambdaCognitoAuthorizerPermission:
    Type: AWS::Lambda::Permission
    Properties:
      Action: lambda:InvokeFunction
      FunctionName:
        Ref: LambdaCognitoAuthorizer
      Principal: apigateway.amazonaws.com
      SourceArn:
        Fn::Sub: arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${ClickCollectWebsocket}/authorizers/${CognitoLambdaAuthorizer}
  LambdaCognitoAuthorizerRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
        - Effect: Allow
          Principal:
            Service:
            - lambda.amazonaws.com
          Action:
          - sts:AssumeRole
      Path: /
  LambdaSignUp:
    Type: AWS::Serverless::Function
    DependsOn:
    - LambdaBasicExecutionPolicy
    Properties:
      CodeUri: s3://ali-su-artifacts/0e385a4971f04d33ae248bb58d774213
      Description: Sign user up by creating a new record in the cognito user pool..
      FunctionName: cognitoSignUp
      Handler: index.handler
      MemorySize: 128
      Role:
        Fn::GetAtt:
        - LambdaSignUpRole
        - Arn
      Runtime: nodejs12.x
      Timeout: 10
      Layers:
      - Ref: serverlessLayer
      Environment:
        Variables:
          USER_POOL_ID:
            Ref: ClickCollectCognitoUserPool
          USER_POOL_CLIENT_ID:
            Ref: ClickCollectCognitoUserPoolClient
  LambdaSignUpPermission:
    Type: AWS::Lambda::Permission
    Properties:
      Action: lambda:InvokeFunction
      FunctionName:
        Fn::GetAtt:
        - LambdaSignUp
        - Arn
      Principal: apigateway.amazonaws.com
      SourceArn:
        Fn::Sub: arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${ClickCollectRestApi}/*/POST/signup
  LambdaSignUpRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
        - Action:
          - sts:AssumeRole
          Effect: Allow
          Principal:
            Service:
            - lambda.amazonaws.com
      Policies:
      - PolicyName: AmazonCognitoDeveloperAuthenticatedIdentities
        PolicyDocument:
          Version: '2012-10-17'
          Statement:
          - Action:
            - cognito-identity:GetOpenIdTokenForDeveloperIdentity
            - cognito-identity:LookupDeveloperIdentity
            - cognito-identity:MergeDeveloperIdentities
            - cognito-identity:UnlinkDeveloperIdentity
            Effect: Allow
            Resource: '*'
  LambdaCognitoAuthenticator:
    Type: AWS::Serverless::Function
    DependsOn:
    - LambdaBasicExecutionPolicy
    Properties:
      FunctionName: LambdaCognitoAuthenticator
      Handler: index.handler
      Runtime: nodejs12.x
      CodeUri: s3://ali-su-artifacts/cc7d26aa03413c3b20a76e56ea49afb7
      Layers:
      - Ref: serverlessLayer
      Timeout: 3
      MemorySize: 128
      Role:
        Fn::GetAtt:
        - LambdaCognitoAuthenticatorRole
        - Arn
      Environment:
        Variables:
          USER_POOL_ID:
            Ref: ClickCollectCognitoUserPool
  LambdaCognitoAuthenticatorPermission:
    Type: AWS::Lambda::Permission
    Properties:
      Action: lambda:InvokeFunction
      FunctionName:
        Ref: LambdaCognitoAuthorizer
      Principal: apigateway.amazonaws.com
      SourceArn:
        Fn::Sub: arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${ClickCollectRestApi}/*/POST/login
  LambdaCognitoAuthenticatorRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
        - Effect: Allow
          Principal:
            Service:
            - lambda.amazonaws.com
          Action:
          - sts:AssumeRole
      Path: /
  LambdaMatchPlayers:
    Type: AWS::Serverless::Function
    DependsOn:
    - LambdaBasicExecutionPolicy
    Properties:
      FunctionName: LambdaMatchPlayers
      Handler: matchPlayers.handler
      Runtime: nodejs12.x
      CodeUri: s3://ali-su-artifacts/6663dd71b407d797b2c848bcb839921d
      Layers:
      - Ref: serverlessLayer
      Timeout: 3
      MemorySize: 128
      Role:
        Fn::GetAtt:
        - LambdaMatchPlayersRole
        - Arn
      Environment:
        Variables:
          DYNAMODB_REQUESTS_TABLE: requests
          MONGO_DB_URI: mongodb+srv://admin:extra4545@cluster0-xebut.mongodb.net/test?retryWrites=true&w=majority
          MAX_DISTANCE: 100
          SQS_REQUEST_QUE_URL:
            Ref: PendingRequestsQue
          WEBSOCKET_API_ENDPOINT:
            Fn::Sub: https://${ClickCollectWebsocket}.execute-api.${AWS::Region}.amazonaws.com/${ClickCollectWebSocketStage}/@connections
  LambdaMatchPlayersPermissions:
    Type: AWS::Lambda::Permission
    Properties:
      FunctionName:
        Fn::GetAtt:
        - LambdaMatchPlayers
        - Arn
      Action: lambda:InvokeFunction
      Principal: events.amazonaws.com
      SourceArn:
        Fn::GetAtt:
        - searchPlayersEventRule
        - Arn
  LambdaMatchPlayersRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
        - Effect: Allow
          Principal:
            Service:
            - lambda.amazonaws.com
          Action:
          - sts:AssumeRole
      Policies:
      - PolicyName: ApiGatewayWebsocketInvokePolicy
        PolicyDocument:
          Version: '2012-10-17'
          Statement:
            Effect: Allow
            Action:
            - execute-api:Invoke
            - execute-api:ManageConnections
            Resource:
              Fn::Sub: arn:aws:apigateway:${AWS::Region}::*
      Path: /
  LambdaProcessPendingGames:
    Type: AWS::Serverless::Function
    DependsOn:
    - LambdaBasicExecutionPolicy
    Properties:
      FunctionName: processPendingGames
      Handler: processPendingGames.handler
      Runtime: nodejs12.x
      CodeUri: s3://ali-su-artifacts/c24583aacd7a3e3583f8eb17fe269584
      Layers:
      - Ref: serverlessLayer
      Timeout: 3
      MemorySize: 128
      Role:
        Fn::GetAtt:
        - LambdaProcessPendingGamesRole
        - Arn
      Environment:
        Variables:
          DYNAMODB_GAMES_TABLE:
            Ref: DynamodbGamesTable
          MONGO_DB_URI: mongodb+srv://admin:extra4545@cluster0-xebut.mongodb.net/test?retryWrites=true&w=majority
          SCHEDULED_QUESTIONS_QUE_URL:
            Ref: PendingGamesQue
          WEBSOCKET_API_ENDPOINT:
            Fn::Sub: https://${ClickCollectWebsocket}.execute-api.${AWS::Region}.amazonaws.com/${ClickCollectWebSocketStage}/@connections
  LambdaProcessPendingGamesPermission:
    Type: AWS::Lambda::Permission
    Properties:
      Action: lambda:InvokeFunction
      FunctionName:
        Ref: LambdaProcessPendingGames
      Principal: dynamodb.amazonaws.com
      SourceArn:
        Fn::GetAtt:
        - DynamodbGamesTable
        - StreamArn
  LambdaProcessPendingGamesRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
        - Effect: Allow
          Principal:
            Service:
            - lambda.amazonaws.com
          Action:
          - sts:AssumeRole
      Policies:
      - PolicyName: ApiGatewayWebsocketInvokePolicy
        PolicyDocument:
          Version: '2012-10-17'
          Statement:
            Effect: Allow
            Action:
            - dynamodb:DescribeStream
            - dynamodb:GetRecords
            - dynamodb:GetShardIterator
            - dynamodb:ListStreams
            - logs:CreateLogGroup
            - logs:CreateLogStream
            - logs:PutLogEvents
            Resource:
              Fn::GetAtt:
              - DynamodbGamesTable
              - Arn
      Path: /
  LambdaProcessPendingRequests:
    Type: AWS::Serverless::Function
    DependsOn:
    - LambdaBasicExecutionPolicy
    Properties:
      FunctionName: processPendingRequests
      Handler: processPendingRequests.handler
      Runtime: nodejs12.x
      CodeUri: s3://ali-su-artifacts/bb8e3383d6dff7de52d9ef04abfecd31
      Layers:
      - Ref: serverlessLayer
      Timeout: 3
      MemorySize: 128
      Role:
        Fn::GetAtt:
        - LambdaProcessPendingRequestsRole
        - Arn
      Environment:
        Variables:
          QUESTIONS_LIMIT: 5
          DYNAMODB_GAMES_TABLE:
            Ref: DynamodbGamesTable
          DYNAMODB_REQUESTS_TABLE:
            Ref: DynamodbRequestsTable
  LambdaProcessPendingRequestsPermission:
    Type: AWS::Lambda::Permission
    Properties:
      Action: lambda:InvokeFunction
      FunctionName:
        Ref: LambdaProcessPendingRequests
      Principal: sqs.amazonaws.com
      SourceArn:
        Fn::GetAtt:
        - PendingRequestsQue
        - Arn
  LambdaProcessPendingRequestsRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
        - Effect: Allow
          Principal:
            Service:
            - lambda.amazonaws.com
          Action:
          - sts:AssumeRole
      Policies:
      - PolicyName: DynamodbRequestsTableReadAccess
        PolicyDocument:
          Version: '2012-10-17'
          Statement:
            Effect: Allow
            Action:
            - dynamodb:GetItem
            Resource:
              Fn::GetAtt:
              - DynamodbRequestsTable
              - Arn
      Path: /
  LambdaProcessPointsTransfer:
    Type: AWS::Serverless::Function
    DependsOn:
    - LambdaBasicExecutionPolicy
    Properties:
      FunctionName: processPointsTransfer
      Handler: index.handler
      Runtime: nodejs12.x
      CodeUri: s3://ali-su-artifacts/7baf30f66c2fab956932355a73f1bcc7
      Layers:
      - Ref: serverlessLayer
      Timeout: 3
      MemorySize: 128
      Role:
        Fn::GetAtt:
        - LambdaProcessPointsTransferRole
        - Arn
      Environment:
        Variables:
          MONGO_DB_URI: mongodb+srv://admin:extra4545@cluster0-xebut.mongodb.net/test?retryWrites=true&w=majority
  LambdaProcessResultsPermission:
    Type: AWS::Lambda::Permission
    Properties:
      Action: lambda:InvokeFunction
      FunctionName:
        Ref: LambdaProcessResults
      Principal: sqs.amazonaws.com
      SourceArn:
        Fn::GetAtt:
        - PendingResultsQue
        - Arn
  LambdaProcessPointsTransferRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
        - Effect: Allow
          Principal:
            Service:
            - lambda.amazonaws.com
          Action:
          - sts:AssumeRole
  LambdaProcessResults:
    Type: AWS::Serverless::Function
    DependsOn:
    - LambdaBasicExecutionPolicy
    Properties:
      FunctionName: processResults
      Handler: index.handler
      Runtime: nodejs12.x
      CodeUri: s3://ali-su-artifacts/e21e29ce07eb17f4874e27eddc6aa955
      Layers:
      - Ref: serverlessLayer
      Timeout: 3
      MemorySize: 128
      Role:
        Fn::GetAtt:
        - LambdaProcessResultsRole
        - Arn
      Environment:
        Variables:
          DYNAMODB_GAMES_TABLE:
            Ref: DynamodbGamesTable
          MONGO_DB_URI: mongodb+srv://admin:extra4545@cluster0-xebut.mongodb.net/test?retryWrites=true&w=majority
          PENDING_POINTS_TRANSFERS_QUE_URL:
            Ref: PendingTransferQue
          WEBSOCKET_API_ENDPOINT:
            Fn::Sub: https://${ClickCollectWebsocket}.execute-api.${AWS::Region}.amazonaws.com/${ClickCollectWebSocketStage}/@connections
  LambdaProcessResultsRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
        - Effect: Allow
          Principal:
            Service:
            - lambda.amazonaws.com
          Action:
          - sts:AssumeRole
      Policies:
      - PolicyName: ApiGatewayWebsocketInvokePolicy
        PolicyDocument:
          Version: '2012-10-17'
          Statement:
            Effect: Allow
            Action:
            - execute-api:Invoke
            - execute-api:ManageConnections
            Resource:
              Fn::Sub: arn:aws:apigateway:${AWS::Region}::*
      Path: /
  LambdaProcessScheduledQuestions:
    Type: AWS::Serverless::Function
    DependsOn:
    - LambdaBasicExecutionPolicy
    Properties:
      FunctionName: processScheduledQuestions
      Handler: index.handler
      Runtime: nodejs12.x
      CodeUri: s3://ali-su-artifacts/2cee5a949a56f725dbea32e7025a17ff
      Layers:
      - Ref: serverlessLayer
      Timeout: 3
      MemorySize: 128
      Role:
        Fn::GetAtt:
        - LambdaProcessScheduledQuestionsRole
        - Arn
      Environment:
        Variables:
          DYNAMODB_GAMES_TABLE:
            Ref: DynamodbGamesTable
          SCHEDULED_QUESTIONS_QUE_URL:
            Ref: PendingQuestionsQue
          SCHEDULE_RESULTS_PROCESS_QUE_URL:
            Ref: PendingResultsQue
          MONGO_DB_URI: mongodb+srv://admin:extra4545@cluster0-xebut.mongodb.net/test?retryWrites=true&w=majority
          WEBSOCKET_API_ENDPOINT:
            Fn::Sub: https://${ClickCollectWebsocket}.execute-api.${AWS::Region}.amazonaws.com/${ClickCollectWebSocketStage}/@connections
  LambdaProcessScheduledQuestionsPermission:
    Type: AWS::Lambda::Permission
    Properties:
      Action: lambda:InvokeFunction
      FunctionName:
        Ref: LambdaProcessScheduledQuestions
      Principal: sqs.amazonaws.com
      SourceArn:
        Fn::GetAtt:
        - PendingQuestionsQue
        - Arn
  LambdaProcessScheduledQuestionsRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
        - Effect: Allow
          Principal:
            Service:
            - lambda.amazonaws.com
          Action:
          - sts:AssumeRole
      Policies:
      - PolicyName: ApiGatewayWebsocketInvokePolicy
        PolicyDocument:
          Version: '2012-10-17'
          Statement:
            Effect: Allow
            Action:
            - execute-api:Invoke
            - execute-api:ManageConnections
            Resource:
              Fn::Sub: arn:aws:apigateway:${AWS::Region}::*
      Path: /
  serverlessLayer:
    Type: AWS::Serverless::LayerVersion
    Properties:
      LayerName: serverlessLayer
      Description: Layer description
      ContentUri: s3://ali-su-artifacts/a027e43fd7f65d0d49eedc9fde4c532c
      CompatibleRuntimes:
      - nodejs12.x
      - nodejs8.10
      LicenseInfo: Available under the MIT-0 license.
      RetentionPolicy: Retain
  LambdaBasicExecutionPolicy:
    Type: AWS::IAM::Policy
    Properties:
      PolicyName: LambdaBasicExecutionPolicy
      Roles:
      - Ref: LambdaWebSocketRouteUpdateLocationRole
      - Ref: LambdaWebSocketRouteSubmitAnswersRole
      - Ref: LambdaProcessScheduledQuestionsRole
      - Ref: LambdaProcessResultsRole
      - Ref: LambdaProcessPointsTransferRole
      - Ref: LambdaProcessPendingRequestsRole
      - Ref: LambdaProcessPendingGamesRole
      - Ref: LambdaMatchPlayersRole
      - Ref: CognitoInitializePlayerRole
      - Ref: WebSocketRouteDisconnectRole
      - Ref: WebSocketRouteConnectRole
      - Ref: LambdaSignUpRole
      - Ref: LambdaCognitoAuthenticatorRole
      - Ref: LambdaCognitoAuthorizerRole
      - Ref: WebSocketRouteRejectRequestRole
      - Ref: WebSocketRouteAcceptRequestRole
      PolicyDocument:
        Version: '2012-10-17'
        Statement:
        - Effect: Allow
          Action:
          - logs:CreateLogGroup
          - logs:CreateLogStream
          - logs:PutLogEvents
          Resource: '*'
Outputs:
  ClickCollectRestApiInvokeURL:
    Value:
      Fn::Sub: https://${ClickCollectRestApi}.execute-api.${AWS::Region}.amazonaws.com/${ClickCollectRestApiStageName}
